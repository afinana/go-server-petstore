/*
 * Swagger Petstore
 *
 * This is a sample server Petstore server.  You can find out more about Swagger at [http://swagger.io](http://swagger.io) or on [irc.freenode.net, #swagger](http://swagger.io/irc/).  For this sample, you can use the api key `special-key` to test the authorization filters.
 *
 * API version: 1.0.6
 * Contact: apiteam@swagger.io
 * Generated by: Swagger Codegen (https://github.com/swagger-api/swagger-codegen.git)
 */

package petstore

import (
	"encoding/json"
	"errors"
	"net/http"

	"github.com/gorilla/mux"
	"go.mongodb.org/mongo-driver/bson/primitive"
	"go.mongodb.org/mongo-driver/mongo"
)

// CreateUser adds a new user to the store
func (app *Application) CreateUser(w http.ResponseWriter, r *http.Request) {
	var m User
	err := json.NewDecoder(r.Body).Decode(&m)
	if err != nil {
		app.serverError(w, err)
		return
	}

	// Insert new Users
	insertResult, err := app.users.Insert(r.Context(), m)
	if err != nil {
		app.serverError(w, err)
		return
	}
	m.ID = insertResult.InsertedID.(primitive.ObjectID)

	app.infoLog.Printf("New user have been created, id=%s", insertResult.InsertedID)
	app.WriteJSON(w, http.StatusOK, m)
}

func (app *Application) CreateUsersWithArrayInput(w http.ResponseWriter, _ *http.Request) {
	app.WriteJSON(w, http.StatusOK, map[string]string{"status": "not implemented"})
}

func (app *Application) CreateUsersWithListInput(w http.ResponseWriter, _ *http.Request) {
	app.WriteJSON(w, http.StatusOK, map[string]string{"status": "not implemented"})
}

func (app *Application) DeleteUser(w http.ResponseWriter, r *http.Request) {
	vars := mux.Vars(r)
	id := vars["id"]

	deleteResult, err := app.users.Delete(r.Context(), id)
	if err != nil {
		app.serverError(w, err)
		return
	}

	app.infoLog.Printf("Have been eliminated %d user(s)", deleteResult.DeletedCount)
	app.WriteJSON(w, http.StatusOK, map[string]int64{"deletedCount": deleteResult.DeletedCount})
}

func (app *Application) GetUserByName(w http.ResponseWriter, r *http.Request) {
	vars := mux.Vars(r)
	name := vars["username"]

	result, err := app.users.FindByUserName(r.Context(), name)
	if err != nil {
		if errors.Is(err, mongo.ErrNoDocuments) {
			app.infoLog.Printf("User not found")
			app.ErrorResponse(w, http.StatusNotFound, "User not found")
			return
		}
		app.serverError(w, err)
		return
	}

	app.WriteJSON(w, http.StatusOK, result)
}

func (app *Application) LoginUser(w http.ResponseWriter, _ *http.Request) {
	app.WriteJSON(w, http.StatusOK, map[string]string{"status": "logged in"})
}

func (app *Application) LogoutUser(w http.ResponseWriter, _ *http.Request) {
	app.WriteJSON(w, http.StatusOK, map[string]string{"status": "logged out"})
}

func (app *Application) UpdateUser(w http.ResponseWriter, r *http.Request) {
	var m User
	err := json.NewDecoder(r.Body).Decode(&m)
	if err != nil {
		app.serverError(w, err)
		return
	}

	updateResult, err := app.users.Update(r.Context(), m.ID.String(), m)
	if err != nil {
		app.serverError(w, err)
		return
	}

	app.infoLog.Printf("User have been updated, id=%s", updateResult.UpsertedID)
	app.WriteJSON(w, http.StatusOK, m)
}

func (app *Application) GetAllUsers(w http.ResponseWriter, r *http.Request) {
	result, err := app.users.All(r.Context())
	if err != nil {
		app.serverError(w, err)
		return
	}

	app.WriteJSON(w, http.StatusOK, result)
}
